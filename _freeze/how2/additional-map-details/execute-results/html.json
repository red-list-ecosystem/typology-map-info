{
  "hash": "5d66f62e41dbc687e88bebfe7a3b33eb",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Map information in database\nexecute: \n eval: true\n---\n\n\nWe will query some information regarding map versions and metadata that is stored in our internal database. \n\n## Set up work directory\n\nWe use library `here` to define relative paths\n\n::: {.cell}\n\n```{.r .cell-code}\nhere::i_am(\"how2/additional-map-details.qmd\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nhere() starts at /Users/z3529065/proyectos/typology-website/typology-map-info\n```\n\n\n:::\n:::\n\n\n## Database\n\n### Database connection\n\nWe store databse credentials in the `_environment.local` file in the project directory. See file `_environment.required` for the format. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(tidyr)\nlibrary(lubridate)\nlibrary(readr)\nlibrary(\"RPostgreSQL\")\n\ndrv <- dbDriver(\"PostgreSQL\") ## remember to update .pgpass file\n\ncon <- dbConnect(drv, \n                 dbname = Sys.getenv(\"DBNAME\"),\n                 host = Sys.getenv(\"DBHOST\"),\n                 port = Sys.getenv(\"DBPORT\"),\n                 user = Sys.getenv(\"DBUSER\"))\n```\n:::\n\n \n### Queries\n\n#### Biome names\nThis information is actually missing from the profile information workbook:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqry <- \"select biome_code, name from biomes;\"\nbiome_info <- dbGetQuery(con,qry)\nwrite_csv(biome_info, file = here::here(\"gisdata\",\"profiles\",\"biome-names.csv\"))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nqry <- \"\nSELECT code, map_code, map_version, license \nFROM map_evaluation \nLEFT JOIN map_metadata \nUSING(map_code, map_version) \nWHERE status = 'valid'\nAND map_type = 'Indicative Map'\nORDER BY license, map_code;\n\"\nmaps_licenses <- dbGetQuery(con,qry)\n\nmaps_licenses |> \n  mutate(biome = str_extract(code, \"[MFST0-9]+\")) |> \n  group_by(biome, license) |> \n  summarise(total = n_distinct(code), .groups = 'drop') |> \n  pivot_wider(names_from=license,values_from = total) |>\n  DT::datatable()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-003889b05e2bddd6f05c\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-003889b05e2bddd6f05c\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\",\"12\",\"13\",\"14\",\"15\",\"16\",\"17\",\"18\",\"19\",\"20\",\"21\",\"22\",\"23\",\"24\",\"25\"],[\"F1\",\"F2\",\"F3\",\"FM1\",\"M1\",\"M2\",\"M3\",\"M4\",\"MFT1\",\"MT1\",\"MT2\",\"MT3\",\"S1\",\"S2\",\"SF1\",\"SF2\",\"SM1\",\"T1\",\"T2\",\"T3\",\"T4\",\"T5\",\"T6\",\"T7\",\"TF1\"],[1,1,4,null,5,null,6,null,1,2,1,null,null,1,null,null,null,1,1,2,3,null,1,3,4],[6,9,1,3,4,5,null,2,1,2,1,1,null,null,1,1,3,3,4,2,1,4,4,2,2],[null,null,null,null,null,null,1,null,null,null,null,null,1,null,1,1,null,null,null,null,1,1,null,null,null],[null,null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,1,null,null,null,null,null,1,null,null,null,null,null,null]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>biome<\\/th>\\n      <th>Commercial use<\\/th>\\n      <th>Non-commercial use<\\/th>\\n      <th>Undocumented<\\/th>\\n      <th>See contact info<\\/th>\\n      <th>NA<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"className\":\"dt-right\",\"targets\":[2,3,4,5,6]},{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"biome\",\"targets\":1},{\"name\":\"Commercial use\",\"targets\":2},{\"name\":\"Non-commercial use\",\"targets\":3},{\"name\":\"Undocumented\",\"targets\":4},{\"name\":\"See contact info\",\"targets\":5},{\"name\":\"NA\",\"targets\":6}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n### Close connection\n\n::: {.cell}\n\n```{.r .cell-code}\ndbDisconnect(con)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.31/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}