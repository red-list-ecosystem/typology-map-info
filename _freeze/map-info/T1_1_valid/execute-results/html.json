{
  "hash": "9d517f33917ca227d0c39fd2d35dd0df",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Valid map for EFG T1.1\"\ndate: 2024 May 6\ncategories:\n - T1\n - valid\nformat:\n html: \n  code-tools:\n   source: true\n---\n\n\nHere comes the information about the valid indicative distribution map for T1.1\n\n\n::: {.cell}\n\n```{.r .cell-code}\nefg_code <- \"T1.1\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(xml2)\nlibrary(terra)\nlibrary(magick)\n\nhere::i_am(\n    sprintf(\"map-info/%s_valid.qmd\", gsub(\"\\\\.\",\"_\", efg_code))\n    )\nout_folder <- here::here(\"gisdata\", \"indicative-maps-bundle\",\"latest\")\n\nmap_details_file <- paste(out_folder, \"map-details.xml\", sep = \"/\")\n# file.exists(map_details_file)\nmap_details <- read_xml(map_details_file)\nmap_info <- map_details |> xml_find_first(sprintf(\"//Map[@efg_code='%s']\", efg_code))\nmap_attrs <- map_info |> xml_attrs()\nds_doi <- map_info |> xml_find_first(\"Dataset-doi\") |> xml_text()\ndownloaded_copy <- here::here(\"gisdata\", \"indicative-maps\", ds_doi)\nefg_details <- read_xml(dir(downloaded_copy,\"xml\", full.names = TRUE))\n```\n:::\n\n\n\n\n## Raster map\n\nWe check the list of map files in the compressed raster archive:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrast_tar <- here::here(out_folder, \"all-maps-raster-geotiff.tar.bz2\")\n```\n:::\n\n\nOr, more directly, using map code and map version attributes:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nraster_name <- \n    sprintf(\"%s_%s.tif\",\n        map_attrs[\"map_code\"],\n        map_attrs[\"map_version\"])\n```\n:::\n\n::: {.cell}\n\n:::\n\n\nExtract the data here (unless it already exists)\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!raster_name %in% dir(workdir))\n    untar(rast_tar, files = raster_name, exdir = workdir)\n```\n:::\n\n\n\nWe'll use the terra library to read the raster file\n\n::: {.cell}\n\n```{.r .cell-code}\nselected_raster <- terra::rast(paste(workdir, raster_name, sep = \"/\"))\n```\n:::\n\n\nSummary of the raster layer according to `terra::rast`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nselected_raster\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \ndimensions  : 21600, 43200, 1  (nrow, ncol, nlyr)\nresolution  : 0.008333333, 0.008333333  (x, y)\nextent      : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)\ncoord. ref. : lon/lat WGS 84 (EPSG:4326) \nsource      : T1.1.web.mix_v2.0.tif \ncolor table : 1 \nname        : T1.1.IM.mix_v2.0 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(selected_raster)\n```\n\n::: {.cell-output-display}\n![](T1_1_valid_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n## Vector map\n\nWe follow similar steps for the vector files. \n\nWe vector archive is here:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvect_tar <- here::here(out_folder, \"all-maps-vector-geojson.tar.bz2\")\n```\n:::\n\n\nWe select the map for this functional group using the map_code and map_version from the map details xml:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvector_name <- \n    sprintf(\"%s_%s.json\",\n        map_info |> xml_attr(\"map_code\"),\n        map_info |> xml_attr(\"map_version\"))\n```\n:::\n\n\nWe uncompress this into the tempdir\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(workdir)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"/Users/z3529065/proyectos/typology-website/typology-map-info/sandbox/latest\"\n```\n\n\n:::\n\n```{.r .cell-code}\nif (!vector_name %in% dir(workdir))\n    untar(vect_tar, files = vector_name, exdir = workdir)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nselected_vector <- terra::vect(paste(workdir, vector_name, sep = \"/\"))\n```\n:::\n\n\nSummary of the raster layer according to `terra::vect`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nselected_vector\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n class       : SpatVector \n geometry    : polygons \n dimensions  : 243624, 1  (geometries, attributes)\n extent      : -180, 180, -32.88333, 30.84167  (xmin, xmax, ymin, ymax)\n source      : T1.1.web.mix_v2.0.json (T1.1)\n coord. ref. : lon/lat WGS 84 (EPSG:4326) \n names       : occurrence\n type        :      <int>\n values      :          2\n                        2\n                        1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(selected_vector)\n```\n:::",
    "supporting": [
      "T1_1_valid_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}